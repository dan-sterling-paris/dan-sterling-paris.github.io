<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battering Ram üêè</title>
    
    <!-- FALLBACK STYLES -->
    <style>
        body { background-color: #131F24; color: white; font-family: sans-serif; margin: 0; }
        #loading-screen { position: fixed; inset: 0; background: #131F24; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        /* Hide Number Spinners */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        /* Touch optimization */
        .touch-manipulation { touch-action: manipulation; }
        
        /* Markdown Styles for AI Response */
        .prose h1, .prose h2, .prose h3 { font-weight: 800; color: #58CC02; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #CE82FF; }
        .prose p { margin-bottom: 0.8em; line-height: 1.5; }
        
        /* Shimmer effect for AI loading text */
        .ai-thinking {
            animation: pulse-text 2s infinite;
        }
        @keyframes pulse-text {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Nunito', 'sans-serif'],
                },
                extend: {
                    colors: {
                        ram: {
                            bg: '#131F24',      /* Dark BG */
                            card: '#202F36',    /* Card BG */
                            primary: '#58CC02', /* Duo Green */
                            primaryDark: '#46a302',
                            secondary: '#CE82FF', /* Purple */
                            accent: '#1CB0F6',  /* Blue */
                            text: '#FFFFFF',
                            muted: '#4B5563',
                            border: '#37464F'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .btn-3d { transition: all 0.05s; border-bottom-width: 4px; }
        .btn-3d:active { border-bottom-width: 0px; transform: translateY(4px); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: #58CC02; cursor: pointer; border: 3px solid white;
            margin-top: -12px; box-shadow: 0 4px 0 #46a302;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #37464F; border-radius: 99px;
        }
        
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: #131F24; }
        body::-webkit-scrollbar-thumb { background: #37464F; border-radius: 4px; }
        
        .exercise-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Select styling override */
        select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
             -webkit-print-color-adjust: exact;
             print-color-adjust: exact;
        }
    </style>
</head>
<body class="min-h-screen pb-40">

    <!-- INITIAL LOADING SCREEN -->
    <div id="loading-screen">
        <div class="text-center">
            <div class="text-6xl animate-bounce mb-4">üêè</div>
            <div class="text-ram-primary font-bold">Loading Pasture...</div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[60] bg-[#131F24] flex flex-col justify-center items-center p-4">
        <div class="text-6xl mb-6 animate-bounce">üêè</div>
        <h1 class="text-3xl font-black text-ram-primary mb-2">Battering Ram</h1>
        <p class="text-ram-muted font-bold mb-8">Who is grazing today?</p>
        
        <div class="grid grid-cols-2 gap-4 w-full max-w-md">
            <button onclick="login('Rammy')" class="btn-3d bg-ram-card hover:bg-[#2a3d46] border-ram-border text-white p-6 rounded-2xl flex flex-col items-center gap-2">
                <span class="text-4xl">üêè</span>
                <span class="font-extrabold text-xl">Rammy</span>
            </button>
            <button onclick="login('Lammy')" class="btn-3d bg-ram-card hover:bg-[#2a3d46] border-ram-border text-white p-6 rounded-2xl flex flex-col items-center gap-2">
                <span class="text-4xl">üêë</span>
                <span class="font-extrabold text-xl">Lammy</span>
            </button>
        </div>
        
        <div class="mt-8 w-full max-w-md">
             <input type="text" id="customUser" placeholder="Or type name..." class="w-full bg-ram-bg border-2 border-ram-border rounded-xl p-3 text-center font-bold outline-none focus:border-ram-primary text-white">
             <button onclick="login(document.getElementById('customUser').value)" class="mt-2 w-full text-ram-muted text-sm font-bold hover:text-white">Enter Guest Name</button>
        </div>
    </div>

    <!-- CHART MODAL -->
    <div id="chartModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[70] flex items-center justify-center">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-80" onclick="closeChart()"></div>
        <div class="modal-container bg-ram-card w-11/12 md:max-w-lg mx-auto rounded-3xl shadow-lg z-50 overflow-hidden border-2 border-ram-border relative p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-ram-primary truncate pr-4" id="chartTitle">Progress</h3>
                <button onclick="closeChart()" class="text-ram-muted hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="h-64 w-full">
                <canvas id="progressChart"></canvas>
            </div>
            <p class="text-xs text-center text-ram-muted mt-4 font-bold uppercase tracking-widest">Max Weight per Session</p>
        </div>
    </div>

    <!-- SUMMARY / FINISH MODAL -->
    <div id="summaryModal" class="hidden fixed inset-0 z-[90] bg-[#131F24] flex flex-col items-center justify-center p-4">
        <div class="bg-ram-card w-full max-w-2xl h-[90vh] rounded-3xl border-2 border-ram-border shadow-2xl flex flex-col overflow-hidden relative">
            
            <!-- Header -->
            <div class="p-6 border-b-2 border-ram-border bg-[#131F24] flex justify-between items-center shrink-0">
                <h2 class="text-2xl font-black text-ram-primary">Session Overview</h2>
                <button onclick="closeSummary()" class="text-ram-muted hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Simple Stats -->
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-[#131F24] p-3 rounded-xl border border-ram-border">
                        <div class="text-xs text-ram-muted font-bold uppercase tracking-tighter">XP Gained</div>
                        <div class="text-xl font-black text-yellow-400" id="summaryXP">0</div>
                    </div>
                    <div class="bg-[#131F24] p-3 rounded-xl border border-ram-border">
                        <div class="text-xs text-ram-muted font-bold uppercase tracking-tighter">Streak</div>
                        <div class="text-xl font-black text-orange-500" id="summaryStreak">0</div>
                    </div>
                    <div class="bg-[#131F24] p-3 rounded-xl border border-ram-border">
                        <div class="text-xs text-ram-muted font-bold uppercase tracking-tighter">Exercises</div>
                        <div class="text-xl font-black text-ram-accent" id="summaryCount">0</div>
                    </div>
                </div>

                <!-- AI Section -->
                <div id="aiSection" class="bg-[#131F24] rounded-2xl border-2 border-ram-border p-4 relative min-h-[150px]">
                    <div class="flex items-center gap-2 mb-3 border-b border-ram-border/50 pb-2">
                        <i class="fas fa-user-md text-ram-secondary text-xl"></i>
                        <span class="font-bold text-lg text-white tracking-tight">PT Progress Audit</span>
                    </div>
                    <div id="aiLoading" class="hidden absolute inset-0 flex items-center justify-center bg-[#131F24]/90 z-10">
                        <div class="text-center">
                            <i class="fas fa-circle-notch fa-spin text-3xl text-ram-secondary mb-2"></i>
                            <p class="text-xs font-bold text-ram-muted animate-pulse">Running historical comparison...</p>
                        </div>
                    </div>
                    <div id="aiContent" class="prose prose-invert text-sm text-gray-300">
                        <p class="text-ram-muted italic">Awaiting session results...</p>
                    </div>
                </div>

                <!-- Text Summary -->
                <div>
                    <h3 class="font-bold text-white mb-2 text-sm uppercase tracking-wider opacity-60">Raw Session Log</h3>
                    <textarea id="summaryText" class="w-full h-32 bg-[#131F24] border-2 border-ram-border rounded-xl p-3 text-xs font-mono text-gray-400 focus:border-ram-primary outline-none resize-none" readonly></textarea>
                    <button onclick="copySummary()" class="mt-2 text-xs font-bold text-ram-accent hover:text-white"><i class="fas fa-copy mr-1"></i> Copy to Clipboard</button>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-4 border-t-2 border-ram-border bg-[#131F24] shrink-0">
                <button onclick="confirmFinish()" class="w-full btn-3d bg-ram-primary hover:bg-ram-primaryDark text-white font-extrabold py-4 rounded-xl border-ram-primaryDark text-lg uppercase tracking-wide">
                    Commit to Database
                </button>
            </div>
        </div>
    </div>
    
    <!-- IMPORT MODAL -->
    <div id="importModal" class="hidden fixed inset-0 z-[80] bg-[#131F24] flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-black text-ram-primary">Import Log</h2>
            <button onclick="document.getElementById('importModal').classList.add('hidden')" class="text-ram-muted hover:text-white"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div class="flex-1 mb-4">
            <textarea id="importText" class="w-full h-full bg-ram-card border-2 border-ram-border rounded-xl p-4 text-xs font-mono text-white focus:border-ram-primary outline-none resize-none" placeholder="Paste logs here..."></textarea>
        </div>
        <button onclick="processImport()" class="btn-3d bg-ram-primary text-white font-bold py-4 rounded-xl border-ram-primaryDark w-full">PROCESS & IMPORT</button>
    </div>

    <!-- NAVBAR -->
    <div class="sticky top-0 z-50 bg-[#131F24]/95 backdrop-blur border-b-2 border-ram-border">
        <div class="max-w-4xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-ram-card px-3 py-1.5 rounded-xl border-2 border-ram-border flex items-center gap-2 cursor-pointer hover:bg-ram-border transition" onclick="logout()" title="Logout">
                    <span class="text-xl" id="userAvatar">üë§</span>
                    <span id="userDisplay" class="font-bold text-sm hidden md:block">Guest</span>
                </div>
                <div class="flex items-center gap-1" title="Current Streak">
                    <i class="fas fa-fire text-orange-500 animate-pulse"></i>
                    <span id="streakDisplay" class="font-black text-orange-500 text-lg">0</span>
                </div>
            </div>
            <div class="flex-1 mx-4 max-w-xs">
                <div class="flex justify-between text-[10px] font-bold text-ram-muted mb-1">
                    <span id="levelDisplay">Lvl 1</span>
                    <span id="xpText">0 XP</span>
                </div>
                <div class="h-3 bg-ram-border rounded-full overflow-hidden">
                    <div id="xpBar" class="h-full bg-yellow-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex gap-2">
                 <button onclick="switchView('history')" class="text-ram-muted hover:text-white transition p-2"><i class="fas fa-scroll text-lg"></i></button>
            </div>
        </div>
    </div>

    <!-- MAIN TRACKER -->
    <main id="view-tracker" class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        <div class="text-center space-y-1">
            <h1 class="text-3xl font-black text-ram-primary tracking-tight">Battering Ram üêè</h1>
        </div>

        <!-- Preset Selector & Units -->
        <div class="bg-ram-card rounded-3xl p-6 border-2 border-ram-border shadow-xl">
            <div class="flex justify-between items-center mb-3">
                <label class="block text-sm font-extrabold text-ram-muted uppercase tracking-wider">Mission</label>
                <!-- Unit Toggle -->
                <div class="flex items-center bg-[#131F24] rounded-lg border-2 border-ram-border p-1">
                    <button onclick="setUnit('kg')" id="btn-kg" class="px-3 py-1 rounded text-xs font-bold transition bg-ram-primary text-white">KG</button>
                    <button onclick="setUnit('lbs')" id="btn-lbs" class="px-3 py-1 rounded text-xs font-bold transition text-ram-muted hover:text-white">LBS</button>
                </div>
            </div>
            
            <div class="relative">
                <select id="presetSelect" onchange="loadPreset()" class="w-full bg-[#131F24] text-white border-2 border-ram-border rounded-2xl p-4 text-lg font-bold focus:border-ram-primary focus:ring-0 outline-none appearance-none cursor-pointer hover:bg-ram-border/50 transition">
                    <option value="">Choose your workout...</option>
                    <option value="A">üí™ DAY A - PUSH (Chest, Shoulders)</option>
                    <option value="B">ü™ú DAY B - PULL (Back, Biceps)</option>
                    <option value="C">ü¶µ DAY C - LEGS (Quads, Hams)</option>
                </select>
            </div>
        </div>

        <!-- Workout Meta -->
        <div id="workoutMeta" class="bg-ram-card rounded-3xl p-6 border-2 border-ram-border space-y-4 hidden">
            <input type="text" id="workoutName" placeholder="Workout Name" class="w-full bg-transparent text-2xl font-black text-white placeholder-ram-muted outline-none border-b-2 border-transparent focus:border-ram-primary transition text-center" value="New Workout">
            <div class="flex flex-wrap gap-2 justify-center">
                <div class="bg-[#131F24] rounded-xl px-3 py-2 border-2 border-ram-border flex-1 min-w-[120px]">
                    <label class="text-[10px] text-ram-muted font-bold uppercase block">Gym</label>
                    <input type="text" id="gymName" value="The Barn" class="bg-transparent font-bold w-full outline-none text-sm text-white placeholder-ram-muted">
                </div>
                <div class="bg-[#131F24] rounded-xl px-3 py-2 border-2 border-ram-border w-1/3 min-w-[110px]">
                    <label class="text-[10px] text-ram-muted font-bold uppercase block">Date</label>
                    <input type="date" id="workoutDate" class="bg-transparent font-bold w-full outline-none text-sm text-white">
                </div>
                <div class="bg-[#131F24] rounded-xl px-3 py-2 border-2 border-ram-border w-1/4 min-w-[90px]">
                    <label class="text-[10px] text-ram-muted font-bold uppercase block">Time</label>
                    <input type="time" id="workoutTime" class="bg-transparent font-bold w-full outline-none text-sm text-white">
                </div>
            </div>
            <textarea id="generalNotes" rows="1" class="w-full bg-[#131F24] border-2 border-ram-border rounded-2xl p-3 text-sm font-semibold focus:border-ram-primary outline-none resize-none text-white" placeholder="Add notes (e.g., 'Feeling woolly today...')"></textarea>
        </div>

        <!-- Exercises -->
        <div id="exercisesContainer" class="space-y-6">
            <div id="emptyState" class="text-center py-10 opacity-50">
                <i class="fas fa-dumbbell text-6xl mb-4 text-ram-border"></i>
                <p class="font-bold text-xl text-ram-muted">Select a workout to start!</p>
            </div>
        </div>

        <!-- Add Button -->
        <button id="addExerciseBtn" onclick="addExercise()" class="hidden w-full py-4 border-2 border-dashed border-ram-border text-ram-muted rounded-3xl hover:bg-ram-card hover:text-ram-primary hover:border-ram-primary transition flex items-center justify-center gap-2 font-extrabold text-lg uppercase tracking-wide">
            <i class="fas fa-plus-circle"></i> Add Custom Exercise
        </button>
    </main>

    <!-- HISTORY VIEW -->
    <main id="view-history" class="hidden max-w-4xl mx-auto px-4 py-6 space-y-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-3xl font-black text-ram-primary">Past Grazing üåø</h2>
            <button onclick="switchView('tracker')" class="btn-3d bg-ram-border hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl border-slate-700">Back</button>
        </div>
        <div class="bg-ram-card rounded-3xl p-6 border-2 border-ram-border text-center">
            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <button onclick="loadHistory()" class="text-sm bg-[#131F24] px-4 py-2 rounded-xl border-2 border-ram-border font-bold hover:text-ram-primary"><i class="fas fa-sync animate-spin-hover"></i> Refresh</button>
                <button onclick="downloadCSV()" class="text-sm bg-[#131F24] px-4 py-2 rounded-xl border-2 border-ram-border font-bold hover:text-ram-primary"><i class="fas fa-file-csv"></i> Download CSV</button>
                <button onclick="openImportModal()" class="text-sm bg-[#131F24] px-4 py-2 rounded-xl border-2 border-ram-border font-bold hover:text-ram-primary text-ram-secondary"><i class="fas fa-file-import"></i> Import Logs</button>
            </div>
            <div id="historyList" class="space-y-6"></div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer id="actionFooter" class="fixed bottom-0 w-full bg-[#131F24] border-t-2 border-ram-border p-4 z-40 hidden">
        <div class="max-w-4xl mx-auto">
            <button onclick="finishWorkout()" id="finishBtn" class="w-full btn-3d bg-ram-primary hover:bg-ram-primaryDark text-white border-ram-primaryDark font-extrabold py-4 px-6 rounded-2xl shadow-xl transform transition flex justify-center items-center gap-3 text-xl uppercase tracking-wider">
                <span>Finish & Claim XP</span> üêè
            </button>
        </div>
    </footer>

    <!-- TEMPLATES -->
    <template id="exercise-template">
        <div class="exercise-card exercise-enter bg-ram-card rounded-3xl overflow-hidden shadow-lg border-2 border-ram-border mb-6">
            <div class="p-4 bg-ram-card border-b-2 border-ram-border flex justify-between items-center gap-3">
                <div class="flex-1">
                    <select class="exercise-name w-full bg-[#202F36] text-xl font-black text-white outline-none border-b border-transparent focus:border-ram-primary appearance-none py-1 cursor-pointer" onchange="handleExerciseChange(this)">
                         <!-- Options populated via JS -->
                    </select>
                </div>
                <!-- Controls: Chart, Move Up, Move Down, Delete -->
                <div class="flex gap-1">
                    <button onclick="showProgress(this)" class="text-ram-accent hover:text-white transition p-2 rounded-full hover:bg-[#131F24]" title="Chart"><i class="fas fa-chart-line"></i></button>
                    <button onclick="moveExercise(this, -1)" class="text-ram-muted hover:text-white transition p-2 rounded-full hover:bg-[#131F24]" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="moveExercise(this, 1)" class="text-ram-muted hover:text-white transition p-2 rounded-full hover:bg-[#131F24]" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                    <button onclick="deleteExercise(this)" class="text-ram-border hover:text-red-400 transition p-2 rounded-full hover:bg-[#131F24]" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
            
            <!-- Summary of last session -->
            <div class="last-session-summary hidden px-4 py-3 bg-[#1a262b] border-b border-ram-border text-xs text-ram-muted font-mono leading-relaxed transition-all">
                <!-- Injected via JS -->
            </div>
            
            <div class="sets-container p-2 space-y-3">
                <!-- Sets inject here -->
            </div>
            <div class="p-3">
                <button onclick="addSet(this)" class="w-full py-3 rounded-xl border-2 border-ram-border text-ram-secondary font-bold hover:bg-[#131F24] transition text-sm uppercase"><i class="fas fa-plus mr-1"></i> Add Set</button>
            </div>
        </div>
    </template>

    <template id="set-template">
        <div class="set-row bg-[#131F24] rounded-xl p-3 border border-ram-border relative group mb-2">
            <!-- Top Row: #, Weight, Reps, Delete -->
            <div class="flex gap-3 items-center mb-3">
                <!-- Set Number -->
                <div class="w-6 flex justify-center items-center">
                    <span class="set-number-display font-black text-ram-primary text-xl">1</span>
                </div>

                <!-- Weight Input -->
                <div class="flex-1 relative">
                    <label class="absolute -top-2 left-2 text-[9px] font-bold text-ram-muted bg-[#131F24] px-1">WEIGHT <span class="unit-label"></span></label>
                    <input type="number" inputmode="decimal" class="set-weight w-full bg-ram-card border border-ram-border rounded-lg h-14 text-center font-black text-2xl text-white focus:border-ram-primary outline-none" placeholder="0">
                </div>

                <!-- Reps Input -->
                <div class="flex-1 relative">
                    <label class="absolute -top-2 left-2 text-[9px] font-bold text-ram-muted bg-[#131F24] px-1">REPS</label>
                    <input type="number" inputmode="decimal" class="set-reps w-full bg-ram-card border border-ram-border rounded-lg h-14 text-center font-black text-2xl text-white focus:border-ram-primary outline-none" placeholder="0">
                </div>

                <!-- Delete -->
                <div class="w-6 flex justify-center">
                    <button onclick="deleteSet(this)" class="text-ram-border hover:text-red-400 p-2"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>

            <!-- Middle Row: RPE Slider -->
            <div class="mb-3 px-1">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-bold text-ram-muted uppercase tracking-wider">Intensity (RPE)</span>
                    <span class="rpe-value text-ram-primary font-black text-sm">7</span>
                </div>
                <input type="range" min="1" max="10" step="0.5" value="7" class="set-rpe w-full h-2 bg-ram-border rounded-lg appearance-none cursor-pointer" oninput="updateRpeDisplay(this); saveToLocalStorage();">
                <div class="flex justify-between text-[8px] text-ram-muted font-bold mt-1 px-1">
                    <span>Easy</span>
                    <span>Hard</span>
                    <span>Max</span>
                </div>
            </div>
            
            <!-- Bottom Row: Notes -->
            <div class="px-1">
                <input type="text" placeholder="Add set notes..." oninput="saveToLocalStorage()" class="set-notes w-full bg-transparent border-b border-ram-border focus:border-ram-primary outline-none text-xs text-ram-muted font-semibold py-1">
            </div>
        </div>
    </template>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        var SUPABASE_URL = "https://oaltkxblacpjjecpauya.supabase.co"; 
        var SUPABASE_KEY = "sb_publishable_TMGWYUqc50BRxAynmGZRoA_YJu1a02f"; 
        // üö® PASTE YOUR GEMINI API KEY BELOW üö®
        const GEMINI_API_KEY = "AIzaSyAYCbD4Y1bDh15UYOl9cp4R-AWEK6aT27o"; 
        // ==========================================

        let dbClient = null;
        let currentUser = null;
        let currentUserId = null; 
        let currentChart = null;
        let currentUnit = 'kg'; 
        let masterExerciseList = new Set();
        
        const LEGACY_LOG_DATA = `Gym
22/10
Lat pull down - 3x12 - 25kg
Hamstring curls - 3x12 - 27kg (the pins prongs on -1 and 6) 
Bent over barbell row - 3x12 - 25kg
Standing head cavers - 3x12 - 6kg
Barbell deadlift - 3x12 - 30kg`;

        const workoutPresets = {
            "A": {
                name: "DAY A - PUSH",
                notes: "Tempo: 1-1-3. Rest: 90s. (Chest, Shoulders, Triceps)",
                exercises: [
                    { name: "Dumbbell Chest Press", sets: 3, reps: 12, weight: "" },
                    { name: "Dumbbell Shoulder Press", sets: 3, reps: 12, weight: "" },
                    { name: "Incline Dumbbell Fly", sets: 3, reps: 12, weight: "" },
                    { name: "Lateral Raises", sets: 3, reps: 12, weight: "" },
                    { name: "Tricep Cable Pushdown", sets: 3, reps: 12, weight: "" }
                ]
            },
            "B": {
                name: "DAY B - PULL",
                notes: "Tempo: 1-1-3. Rest: 90s. (Back, Biceps, Rear Delt)",
                exercises: [
                    { name: "Lat Pulldown", sets: 3, reps: 12, weight: "" },
                    { name: "Seated Cable Row", sets: 3, reps: 12, weight: "" },
                    { name: "Cable Face Pulls", sets: 3, reps: 15, weight: "" },
                    { name: "Standing Hammer Curls", sets: 3, reps: 12, weight: "" },
                    { name: "Seated Dumbbell Bicep Curls", sets: 3, reps: 12, weight: "" }
                ]
            },
            "C": {
                name: "DAY C - LEGS",
                notes: "Tempo: 1-1-3. Rest: 90s. (Quads, Hamstrings)",
                exercises: [
                    { name: "Barbell Squat", sets: 3, reps: 12, weight: "" },
                    { name: "Leg Extension", sets: 3, reps: 12, weight: "" },
                    { name: "Seated Leg Curl", sets: 3, reps: 12, weight: "" },
                    { name: "45¬∞ Back Extension", sets: 3, reps: 12, weight: "" },
                    { name: "Standing Calf Raises", sets: 3, reps: 15, weight: "" }
                ]
            }
        };

        let userStats = { xp: 0, level: 1, streak: 0, lastWorkoutDate: null, defaultGym: "" };
        let pendingWorkoutData = null; 

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading-screen').style.display = 'none';

            if(typeof window.supabase !== 'undefined' && SUPABASE_URL && SUPABASE_KEY) {
                try {
                    dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } catch(e) { console.error("Supabase init failed:", e); }
            }

            setDateTime();
            loadMasterExercises();

            const storedUser = localStorage.getItem('ram_currentUser');
            if (storedUser) {
                login(storedUser);
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
            
            document.getElementById('view-tracker').addEventListener('input', debounce(saveToLocalStorage, 500));
        });

        // --- Unit Logic ---
        window.setUnit = function(unit) {
            if(currentUnit === unit) return;
            currentUnit = unit;
            
            if(unit === 'kg') {
                document.getElementById('btn-kg').className = "px-3 py-1 rounded text-xs font-bold transition bg-ram-primary text-white";
                document.getElementById('btn-lbs').className = "px-3 py-1 rounded text-xs font-bold transition text-ram-muted hover:text-white";
            } else {
                document.getElementById('btn-lbs').className = "px-3 py-1 rounded text-xs font-bold transition bg-ram-primary text-white";
                document.getElementById('btn-kg').className = "px-3 py-1 rounded text-xs font-bold transition text-ram-muted hover:text-white";
            }

            document.querySelectorAll('.unit-label').forEach(el => el.textContent = `(${unit.toUpperCase()})`);

            const weightInputs = document.querySelectorAll('.set-weight');
            weightInputs.forEach(input => {
                const val = parseFloat(input.value);
                if(!isNaN(val)) {
                    if(unit === 'lbs') {
                        input.value = (val * 2.20462).toFixed(1).replace('.0','');
                    } else {
                        input.value = (val / 2.20462).toFixed(2).replace('.00','');
                    }
                }
            });
            saveToLocalStorage();
        }

        // --- Standard Logic ---

        window.login = async function(username) {
            if(!username) return;
            currentUser = username;
            localStorage.setItem('ram_currentUser', currentUser);
            document.getElementById('userDisplay').textContent = currentUser;
            document.getElementById('userAvatar').textContent = currentUser === 'Rammy' ? 'üêè' : (currentUser === 'Lammy' ? 'üêë' : 'üë§');
            document.getElementById('loginModal').classList.add('hidden');
            
            await loadUserStats();
            await loadMasterExercises(); 
            loadFromLocalStorage();
        }
        
        async function loadMasterExercises() {
            Object.values(workoutPresets).forEach(p => p.exercises.forEach(e => masterExerciseList.add(e.name)));
            
            if(dbClient) {
                try {
                    const { data, error } = await dbClient.from('exercises').select('name').order('name');
                    if(data) {
                        data.forEach(e => masterExerciseList.add(e.name));
                    }
                } catch(e) { console.error("Error loading exercises", e); }
            }
            refreshAllDropdowns();
        }
        
        function generateExerciseOptions(selectedName = "") {
            let html = `<option value="__NEW__" class="font-bold text-ram-accent bg-ram-card">+ Add New Exercise...</option>`;
            html += `<option disabled>----------------</option>`;
            const sorted = Array.from(masterExerciseList).sort();
            if(selectedName && !masterExerciseList.has(selectedName)) {
                html += `<option value="${selectedName}" selected>${selectedName}</option>`;
            } else if (!selectedName) {
                html += `<option value="" selected disabled>Select Exercise</option>`;
            }
            sorted.forEach(name => {
                const isSelected = name === selectedName ? 'selected' : '';
                html += `<option value="${name}" ${isSelected}>${name}</option>`;
            });
            return html;
        }
        
        function refreshAllDropdowns() {
            const selects = document.querySelectorAll('select.exercise-name');
            selects.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = generateExerciseOptions(currentVal);
                sel.value = currentVal; 
            });
        }
        
        // --- GEMINI SUMMARY FOR SINGLE EXERCISE (PEER-STYLE) ---
        async function fetchGeminiExerciseSummary(exerciseName, dateStr, logs) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("YOUR_API_KEY")) return null;

            const setsData = logs.map((l, i) => `Set ${i+1}: ${l.weight}${currentUnit} x ${l.reps} (RPE: ${l.rpe || '?'})`).join(', ');
            
            const prompt = `
                Context: You are a peer-level gym partner. Keep it analytical but human. Avoid wanky enthusiasm.
                Task: In one factual sentence, summarize how I did on ${exerciseName} on ${dateStr}.
                Data: ${setsData}.
                Example: "You finished with ${logs[logs.length-1].weight}${currentUnit} for ${logs[logs.length-1].reps} at RPE ${logs[logs.length-1].rpe}, which looked like a solid effort for 3 sets."
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) {
                return null;
            }
        }

        async function hydrateExerciseCard(card, exerciseName) {
            if(!dbClient || !currentUserId || !exerciseName) return;
            
            const summaryDiv = card.querySelector('.last-session-summary');
            summaryDiv.classList.remove('hidden');
            summaryDiv.innerHTML = '<span class="ai-thinking text-[10px] opacity-50 uppercase tracking-widest">üêè Syncing history...</span>';
            
            try {
                const { data: exData } = await dbClient.from('exercises').select('id').eq('name', exerciseName).single();
                
                if(exData) {
                    const { data: recentLog } = await dbClient.from('workout_logs')
                        .select('workout_id, workouts!inner(date, user_id)')
                        .eq('exercise_id', exData.id)
                        .eq('workouts.user_id', currentUserId)
                        .order('date', { foreignTable: 'workouts', ascending: false })
                        .order('id', { ascending: false })
                        .limit(1)
                        .maybeSingle();

                    if(recentLog) {
                        const { data: historyLogs } = await dbClient.from('workout_logs')
                            .select('*')
                            .eq('workout_id', recentLog.workout_id)
                            .eq('exercise_id', exData.id)
                            .order('set_index', { ascending: true });

                        if(historyLogs && historyLogs.length > 0) {
                            const dateStr = new Date(recentLog.workouts.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                            
                            // RAW DATA FALLBACK
                            let rawSummary = `<span class="text-ram-muted font-bold">${dateStr}:</span> `;
                            rawSummary += historyLogs.map(l => `${l.weight}${currentUnit}x${l.reps}`).join(', ');
                            summaryDiv.innerHTML = rawSummary;

                            // AI UPGRADE
                            fetchGeminiExerciseSummary(exerciseName, dateStr, historyLogs).then(aiText => {
                                if(aiText) {
                                    summaryDiv.innerHTML = `<span class="text-ram-primary/60 font-bold"><i class="fas fa-history mr-1"></i></span> <span class="text-gray-400">${aiText}</span>`;
                                }
                            });

                            const rows = card.querySelectorAll('.set-row');
                            rows.forEach((row, idx) => {
                                if(historyLogs[idx]) {
                                    const rowW = row.querySelector('.set-weight');
                                    const rowR = row.querySelector('.set-reps');
                                    if(rowW.value === "" || rowW.value === "0") {
                                        let lastW = historyLogs[idx].weight;
                                        if(currentUnit === 'lbs' && lastW) lastW = (lastW * 2.20462).toFixed(1).replace('.0','');
                                        rowW.value = lastW;
                                        rowW.classList.add('bg-ram-primary', 'bg-opacity-20');
                                        setTimeout(() => rowW.classList.remove('bg-ram-primary', 'bg-opacity-20'), 1000);
                                    }
                                    if(rowR.value === "" || rowR.value === "0") {
                                        rowR.value = historyLogs[idx].reps;
                                    }
                                }
                            });
                        }
                    } else {
                        summaryDiv.innerHTML = "New territory. No previous logs found.";
                    }
                }
            } catch(e) {
                summaryDiv.innerHTML = "History link broken.";
            }
        }
        
        window.handleExerciseChange = async function(selectElem) {
            const val = selectElem.value;
            if (val === "__NEW__") {
                const newName = prompt("New exercise name:");
                if (newName && newName.trim()) {
                    const cleanName = newName.trim();
                    masterExerciseList.add(cleanName);
                    if (dbClient) await dbClient.from('exercises').upsert({ name: cleanName }, { onConflict: 'name' });
                    refreshAllDropdowns();
                    selectElem.value = cleanName;
                } else selectElem.selectedIndex = 2; 
            } else {
                const card = selectElem.closest('.exercise-card');
                hydrateExerciseCard(card, val);
            }
            saveToLocalStorage();
        }

        window.logout = function() {
            if(confirm("Logout?")) {
                localStorage.removeItem('ram_currentUser');
                location.reload();
            }
        }

        async function loadUserStats() {
            if(dbClient) {
                let { data, error } = await dbClient.from('users').select('*').eq('username', currentUser).single();
                if (!data && !error) {
                     const res = await dbClient.from('users').insert({ username: currentUser }).select().single();
                     if (res.data) data = res.data;
                }
                if(data) {
                    currentUserId = data.id; 
                    userStats = { xp: data.xp || 0, level: data.level || 1, streak: data.streak || 0, lastWorkoutDate: data.last_workout_date, defaultGym: data.default_gym };
                }
            } else {
                const saved = localStorage.getItem(`ram_stats_${currentUser}`);
                if(saved) userStats = JSON.parse(saved);
            }
            updateUIStats();
            const gymInput = document.getElementById('gymName');
            if(gymInput && (!gymInput.value || gymInput.value === 'The Barn') && userStats.defaultGym) {
                gymInput.value = userStats.defaultGym;
            } else if (!gymInput.value || gymInput.value === 'The Barn') {
                if(currentUser === 'Rammy') gymInput.value = 'The Barn';
                if(currentUser === 'Lammy') gymInput.value = 'The Meadow';
            }
        }

        async function saveUserStats() {
            updateUIStats();
            if(dbClient && currentUserId) {
                await dbClient.from('users').update({ 
                    xp: userStats.xp, 
                    level: userStats.level, 
                    streak: userStats.streak, 
                    last_workout_date: userStats.lastWorkoutDate, 
                    default_gym: document.getElementById('gymName').value 
                }).eq('id', currentUserId);
            }
            localStorage.setItem(`ram_stats_${currentUser}`, JSON.stringify(userStats));
        }

        function updateUIStats() {
            const level = Math.floor(userStats.xp / 100) + 1;
            const currentLevelXP = userStats.xp % 100;
            document.getElementById('streakDisplay').textContent = userStats.streak;
            document.getElementById('levelDisplay').textContent = `Lvl ${level}`;
            document.getElementById('xpText').textContent = `${currentLevelXP} / 100 XP`;
            document.getElementById('xpBar').style.width = `${currentLevelXP}%`;
        }

        window.loadPreset = async function() {
            if(!currentUser) return;
            const select = document.getElementById('presetSelect');
            const val = select.value;
            if (!val || !workoutPresets[val]) return;

            const presetData = workoutPresets[val];
            document.getElementById('workoutName').value = presetData.name;
            document.getElementById('generalNotes').value = presetData.notes;
            document.getElementById('workoutMeta').classList.remove('hidden');
            document.getElementById('addExerciseBtn').classList.remove('hidden');
            document.getElementById('actionFooter').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            const container = document.getElementById('exercisesContainer');
            container.innerHTML = ''; 
            const exerciseInputs = [];

            presetData.exercises.forEach(ex => {
                const card = createExerciseCard(ex.name);
                container.appendChild(card);
                const setsContainer = card.querySelector('.sets-container');
                for(let i=0; i<ex.sets; i++) {
                    setsContainer.appendChild(createSetRow(i+1, ex.weight, ex.reps));
                }
                exerciseInputs.push({ name: ex.name, card: card });
            });

            saveToLocalStorage();

            if(dbClient && currentUserId) {
                for (const exItem of exerciseInputs) {
                    hydrateExerciseCard(exItem.card, exItem.name);
                }
            }
        }

        window.createExerciseCard = function(name = "") {
            const tmpl = document.getElementById('exercise-template');
            const clone = tmpl.content.cloneNode(true);
            const card = clone.querySelector('.exercise-card');
            const select = card.querySelector('.exercise-name');
            select.innerHTML = generateExerciseOptions(name);
            select.value = name; 
            card.querySelectorAll('.unit-label').forEach(el => el.textContent = `(${currentUnit.toUpperCase()})`);
            return card;
        }

        window.createSetRow = function(number, weight = "", reps = "") {
            const tmpl = document.getElementById('set-template');
            const clone = tmpl.content.cloneNode(true);
            const row = clone.querySelector('.set-row');
            row.querySelector('.set-number-display').textContent = number;
            row.querySelector('.set-weight').value = weight;
            row.querySelector('.set-reps').value = reps;
            return row;
        }

        window.addExercise = function() {
            const container = document.getElementById('exercisesContainer');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('actionFooter').classList.remove('hidden');
            const card = createExerciseCard(); 
            container.appendChild(card);
            card.querySelector('.sets-container').appendChild(createSetRow(1));
            card.querySelector('.exercise-name').focus();
            saveToLocalStorage();
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        window.moveExercise = function(btn, direction) {
            const card = btn.closest('.exercise-card');
            const container = document.getElementById('exercisesContainer');
            if (direction === -1 && card.previousElementSibling && card.previousElementSibling.id !== 'emptyState') {
                container.insertBefore(card, card.previousElementSibling);
            } else if (direction === 1 && card.nextElementSibling) {
                container.insertBefore(card.nextElementSibling, card);
            }
            saveToLocalStorage();
        }

        window.addSet = function(btn) {
            const card = btn.closest('.exercise-card');
            const setsContainer = card.querySelector('.sets-container');
            const currentSets = setsContainer.querySelectorAll('.set-row');
            let prevWeight = "", prevReps = "";
            if(currentSets.length > 0) {
                const lastSet = currentSets[currentSets.length - 1];
                prevWeight = lastSet.querySelector('.set-weight').value;
                prevReps = lastSet.querySelector('.set-reps').value;
            }
            setsContainer.appendChild(createSetRow(currentSets.length + 1, prevWeight, prevReps));
            saveToLocalStorage();
        }

        window.deleteExercise = function(btn) {
            if(confirm("Delete exercise?")) {
                btn.closest('.exercise-card').remove();
                saveToLocalStorage();
            }
        }
        
        window.deleteSet = function(btn) {
            const row = btn.closest('.set-row');
            const container = row.parentElement;
            row.remove();
            container.querySelectorAll('.set-row').forEach((r, i) => r.querySelector('.set-number-display').textContent = i + 1);
            saveToLocalStorage();
        }

        window.updateRpeDisplay = function(rangeInput) {
            const val = parseFloat(rangeInput.value);
            const rpeVal = rangeInput.parentElement.querySelector('.rpe-value');
            if(rpeVal) {
                rpeVal.textContent = val;
                if(val >= 9) rpeVal.className = "rpe-value text-red-500 font-black ml-1";
                else if(val >= 7) rpeVal.className = "rpe-value text-ram-primary font-black ml-1";
                else rpeVal.className = "rpe-value text-ram-accent font-black ml-1";
            }
        }

        window.resetApp = function() {
            if(confirm("Clear current form?")) {
                localStorage.removeItem(`ram_draft_${currentUser}`);
                location.reload();
            }
        }

        // --- CHARTING ---
        window.showProgress = async function(btn) {
            const card = btn.closest('.exercise-card');
            const exerciseName = card.querySelector('.exercise-name').value;
            if(!exerciseName) return;
            document.getElementById('chartTitle').textContent = `${exerciseName} - ${currentUser}`;
            if(!dbClient || !currentUserId) return;
            const { data: exData } = await dbClient.from('exercises').select('id').eq('name', exerciseName).single();
            if(!exData) return;
            const { data } = await dbClient.from('workout_logs').select('weight, workouts(date, user_id)').eq('exercise_id', exData.id).order('id', { ascending: true });
            if(!data || data.length === 0) return;
            const labels = []; const dataPoints = []; const dayMax = {};
            data.forEach(log => {
                if(log.workouts.user_id === currentUserId) {
                    const d = log.workouts.date.split('T')[0];
                    const w = parseFloat(log.weight);
                    if(!dayMax[d] || w > dayMax[d]) dayMax[d] = w;
                }
            });
            Object.keys(dayMax).sort().forEach(date => { labels.push(date); dataPoints.push(dayMax[date]); });
            renderChart(labels, dataPoints);
            document.getElementById('chartModal').classList.remove('opacity-0', 'pointer-events-none');
        }

        function renderChart(labels, dataPoints) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if(currentChart) currentChart.destroy();
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Max Lift', data: dataPoints,
                        borderColor: '#58CC02', backgroundColor: 'rgba(88, 204, 2, 0.1)', borderWidth: 3, pointRadius: 4, fill: true, tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#37464F' } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.closeChart = function() {
            document.getElementById('chartModal').classList.add('opacity-0', 'pointer-events-none');
        }
        
        // --- SUMMARY & SAVE ---
        window.finishWorkout = async function() {
            const workoutData = getWorkoutDataFromDOM();
            let summary = `üêè SESSION SUMMARY (${currentUser})\n`;
            summary += `üìÖ ${workoutData.date} | ${workoutData.name}\n`;
            summary += `-------------------------\n`;
            let setCounter = 0;
            workoutData.exercises.forEach(ex => {
                summary += `üîπ ${ex.name}\n`;
                ex.sets.forEach((set, idx) => {
                    setCounter++;
                    if(set.weight || set.reps) summary += `   ${idx+1}: ${set.weight}${currentUnit} x ${set.reps} (RPE ${set.rpe})\n`;
                });
            });
            
            const xpGained = setCounter * 10;
            document.getElementById('summaryXP').textContent = `+${xpGained}`;
            document.getElementById('summaryStreak').textContent = userStats.streak + 1; 
            document.getElementById('summaryCount').textContent = workoutData.exercises.length;
            document.getElementById('summaryText').value = summary;
            document.getElementById('aiContent').innerHTML = '<p class="text-ram-muted italic">Running performance audit...</p>';
            
            pendingWorkoutData = workoutData; 
            pendingWorkoutData.xpGained = xpGained;
            pendingWorkoutData.summary = summary; 
            
            document.getElementById('summaryModal').classList.remove('hidden');
            callGeminiTrainer(workoutData);
        }
        
        window.closeSummary = function() {
            document.getElementById('summaryModal').classList.add('hidden');
        }
        
        window.copySummary = function() {
            const txt = document.getElementById('summaryText');
            txt.select(); document.execCommand('copy');
            alert("Log copied!");
        }
        
        // --- GEMINI PROGRESS AUDIT (ANALYTICAL PERSONA) ---
        async function callGeminiTrainer(currentWorkout) {
            if(!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                document.getElementById('aiContent').innerHTML = `<p class="text-yellow-500">API Key missing. Progression audit disabled.</p>`;
                return;
            }
            
            document.getElementById('aiLoading').classList.remove('hidden');
            
            try {
                let historyContext = "No history context found.";
                let startContext = "Unknown start date.";
                
                if(dbClient && currentUserId) {
                    // Fetch last 10 workouts for detailed trend analysis
                    const { data: recentHist } = await dbClient.from('workouts')
                        .select('date, name, notes')
                        .eq('user_id', currentUserId)
                        .order('date', { ascending: false })
                        .limit(10);
                        
                    // Fetch oldest workout for "since the start" contrast
                    const { data: firstHist } = await dbClient.from('workouts')
                        .select('date, name, notes')
                        .eq('user_id', currentUserId)
                        .order('date', { ascending: true })
                        .limit(1);

                    if(recentHist) historyContext = JSON.stringify(recentHist);
                    if(firstHist && firstHist.length > 0) startContext = JSON.stringify(firstHist[0]);
                }
                
                const prompt = `
                    System Role: Expert Personal Trainer. Persona: Analytical, human, peer-like, objective. No wanky marketing speak.
                    Goal: Provide a useful audit of the current workout vs historical progression.
                    
                    USER: ${currentUser}
                    CURRENT SESSION: ${JSON.stringify(currentWorkout.exercises)}
                    RECENT HISTORY (Last 10): ${historyContext}
                    STARTING CONTEXT: ${startContext}
                    
                    ANALYSIS REQUIREMENTS:
                    1. **Volume & Intensity:** Objective summary of today's workload.
                    2. **Progress vs History:** Identify specific instances of Progressive Overload (weight increases, rep bumps) from today vs the last few sessions.
                    3. **Long-term Trend:** Compare today's lifts against the starting context. Quantify the progress (e.g., "You're moving 20% more weight on compound lifts than when you started").
                    4. **Observation:** One professional, anatomical observation or form warning based on notes/rpe.
                    
                    Constraint: Max 180 words. Markdown format.
                `;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Audit failed to generate.";
                pendingWorkoutData.aiResponse = aiText;
                document.getElementById('aiContent').innerHTML = marked.parse(aiText);
            } catch(e) {
                document.getElementById('aiContent').innerHTML = `<p class="text-red-500">Analysis offline: ${e.message}</p>`;
            } finally {
                document.getElementById('aiLoading').classList.add('hidden');
            }
        }

        window.confirmFinish = async function() {
            const btn = document.querySelector('#summaryModal button[onclick="confirmFinish()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FINALIZING...';
            btn.disabled = true;
            
            const workoutData = pendingWorkoutData;
            if(workoutData.aiResponse) {
                workoutData.notes = (workoutData.notes || "") + "\n\n[RAM_AUDIT]: " + workoutData.aiResponse;
            }
            
            // Standardize to KG for storage
            if(currentUnit === 'lbs') {
                workoutData.exercises.forEach(ex => {
                    ex.sets.forEach(set => {
                        if(set.weight) set.weight = (parseFloat(set.weight) / 2.20462).toFixed(2).replace('.00','');
                    });
                });
            }

            userStats.xp += workoutData.xpGained;
            const today = new Date().toISOString().split('T')[0];
            if(userStats.lastWorkoutDate !== today) { userStats.streak += 1; userStats.lastWorkoutDate = today; }
            await saveUserStats();

            if(dbClient && currentUserId) {
                try {
                    const { data: wData, error: wError } = await dbClient.from('workouts').insert({
                        user_id: currentUserId,
                        name: workoutData.name,
                        date: workoutData.date ? new Date(workoutData.date).toISOString() : new Date().toISOString(),
                        duration: workoutData.time,
                        gym_name: workoutData.gym,
                        notes: workoutData.notes
                    }).select().single();

                    if(wError) throw wError;
                    const workoutId = wData.id;

                    for (let i = 0; i < workoutData.exercises.length; i++) {
                        const ex = workoutData.exercises[i];
                        let exId = null;
                        const { data: existingEx } = await dbClient.from('exercises').select('id').eq('name', ex.name).single();
                        if (existingEx) exId = existingEx.id;
                        else {
                            const { data: newEx } = await dbClient.from('exercises').insert({ name: ex.name }).select().single();
                            if(newEx) exId = newEx.id;
                        }
                        if(exId) {
                            const logsToInsert = ex.sets.map((set, idx) => ({
                                workout_id: workoutId, exercise_id: exId, set_index: idx + 1, exercise_order: i + 1, 
                                reps: set.reps || 0, weight: set.weight || 0, rpe: set.rpe, notes: set.notes
                            }));
                            await dbClient.from('workout_logs').insert(logsToInsert);
                        }
                    }
                } catch(err) { console.error(err); }
            }
            localStorage.removeItem(`ram_draft_${currentUser}`);
            location.reload();
        }

        window.loadHistory = async function() {
            const list = document.getElementById('historyList');
            list.innerHTML = `<div class="py-10 opacity-50 uppercase tracking-widest text-xs">üêè Loading Grazing Logs...</div>`;
            if(!dbClient || !currentUserId) return;

            const { data: workouts } = await dbClient.from('workouts').select('*').eq('user_id', currentUserId).order('date', { ascending: false }).limit(10);
            if(!workouts || workouts.length === 0) { list.innerHTML = `<div class="py-10 opacity-30 italic">Pastures are empty.</div>`; return; }
            
            const workoutsWithLogs = await Promise.all(workouts.map(async (w) => {
                const { data: logs } = await dbClient.from('workout_logs').select('*, exercises(name)').eq('workout_id', w.id).order('exercise_order', { ascending: true }).order('set_index', { ascending: true });
                return { ...w, logs };
            }));

            list.innerHTML = '';
            workoutsWithLogs.forEach(workout => {
                const item = document.createElement('div');
                item.className = 'bg-[#131F24] p-4 rounded-2xl border-2 border-ram-border text-left';
                let stats = "";
                if(workout.logs) {
                    const grouped = workout.logs.reduce((acc, log) => {
                        const exName = log.exercises?.name || 'Unknown';
                        const key = `${log.exercise_order}_${exName}`;
                        if(!acc[key]) acc[key] = { name: exName, sets: [] };
                        acc[key].sets.push(log);
                        return acc; group
                    }, {});
                    Object.values(grouped).forEach(exGroup => {
                        let rows = "";
                        exGroup.sets.forEach((s, i) => {
                             if(s.weight || s.reps) rows += `<tr class="border-b border-ram-border/50 text-xs"><td class="py-1 text-ram-muted font-bold">${s.set_index}</td><td class="py-1 text-white font-bold">${s.weight}</td><td class="py-1 text-white">${s.reps}</td><td class="py-1 text-ram-accent">${s.rpe || '-'}</td><td class="py-1 text-ram-muted italic truncate max-w-[80px]">${s.notes || ''}</td></tr>`;
                        });
                        stats += `<div class="mt-4 mb-2"><div class="font-bold text-ram-primary text-sm border-b border-ram-border pb-1 mb-2">${exGroup.name}</div><table class="w-full text-center"><thead><tr class="text-[10px] text-ram-muted uppercase tracking-wider"><th class="pb-1 font-bold">Set</th><th class="pb-1 font-bold">Kg</th><th class="pb-1 font-bold">Reps</th><th class="pb-1 font-bold">RPE</th><th class="pb-1 font-bold">Note</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                    });
                }
                item.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="font-black text-white text-lg mt-1">${workout.name || 'Session'}</h3><div class="flex items-start gap-3"><div class="text-right"><div class="text-xs font-bold text-ram-primary">${new Date(workout.date).toLocaleDateString()}</div><div class="text-[10px] text-ram-muted uppercase tracking-tighter">${workout.gym_name || 'Gym'}</div></div><button onclick="deleteWorkout('${workout.id}')" class="text-ram-border hover:text-red-500 pt-1"><i class="fas fa-trash-alt"></i></button></div></div><div class="pl-2 border-l-2 border-ram-border">${stats}</div>`;
                list.appendChild(item);
            });
        }
        
        window.deleteWorkout = async function(id) {
            if(!confirm("Erase this session?")) return;
            if(dbClient) {
                const { error } = await dbClient.from('workouts').delete().eq('id', id);
                if(!error) loadHistory();
            }
        }
        
        window.openImportModal = function() {
            document.getElementById('importModal').classList.remove('hidden');
            const txt = document.getElementById('importText');
            if(!txt.value) txt.value = LEGACY_LOG_DATA;
        }

        window.processImport = async function() {
            const text = document.getElementById('importText').value;
            if(!text) return;
            const btn = document.querySelector('#importModal button');
            btn.textContent = "UPLOADING..."; btn.disabled = true;
            const workouts = parseLegacyLogs(text);
            if(dbClient && currentUserId) {
                for(const w of workouts) {
                    try {
                        const { data: wRes } = await dbClient.from('workouts').insert({ user_id: currentUserId, name: w.workout_name, date: new Date(w.date).toISOString(), duration: w.time, gym_name: w.gym_name, notes: w.notes }).select().single();
                        for (let i = 0; i < w.exercises.length; i++) {
                            const ex = w.exercises[i];
                            let exId = null;
                            const { data: existing } = await dbClient.from('exercises').select('id').eq('name', ex.name).single();
                            if(existing) exId = existing.id;
                            else { const { data: nEx } = await dbClient.from('exercises').insert({ name: ex.name }).select().single(); if(nEx) exId = nEx.id; }
                            if(exId) {
                                const logs = ex.sets.map((s, idx) => ({ workout_id: wRes.id, exercise_id: exId, set_index: idx + 1, exercise_order: i + 1, reps: s.reps, weight: s.weight, rpe: s.rpe, notes: s.notes }));
                                await dbClient.from('workout_logs').insert(logs);
                            }
                        }
                    } catch(e) {}
                }
                alert("Imported."); document.getElementById('importModal').classList.add('hidden'); loadHistory();
            }
            btn.textContent = "PROCESS & IMPORT"; btn.disabled = false;
        }
        
        function parseLegacyLogs(text) {
            const sessions = []; const lines = text.split('\n'); let currentSession = null; let currentExercises = []; let sessionNotes = "";
            const dateRegex = /(\d{1,2}\/\d{1,2}(?:\/\d{2,4})?)/;
            const closeSession = () => { if(currentSession && currentExercises.length > 0) sessions.push({ workout_name: "Legacy Log", date: currentSession.date, time: currentSession.time || "12:00", gym_name: currentSession.gym || "Gym", notes: sessionNotes.trim(), exercises: currentExercises }); };
            for(let line of lines) {
                line = line.trim(); if(!line) continue;
                const dateMatch = line.match(dateRegex);
                if (dateMatch && line.length < 50) {
                    closeSession(); let dateStr = dateMatch[1]; const parts = dateStr.split('/'); let day = parseInt(parts[0]); let month = parseInt(parts[1]); let year = parts[2] ? (parts[2].length === 2 ? '20'+parts[2] : parts[2]) : (month >= 10 ? '2025' : '2026');
                    currentSession = { date: `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`, gym: line.toLowerCase().replace(dateStr,'').replace('gym','').replace('-','').trim() || "Gym", time: "12:00" };
                    currentExercises = []; sessionNotes = ""; continue;
                }
                if(!currentSession) continue;
                if (line.includes('-') && /\d/.test(line)) {
                    const parts = line.split('-').map(s => s.trim()); const name = parts[0]; let sets = 3, reps = 12, weight = 0; let metaFound = false;
                    for(let part of parts) {
                        const setRepMatch = part.match(/(\d+)\s*[xX]\s*(\d+)/);
                        if(setRepMatch) { sets = parseInt(setRepMatch[1]); reps = parseInt(setRepMatch[2]); metaFound = true; }
                        const weightMatch = part.match(/(\d+(?:\.\d+)?)\s*kg/i); if(weightMatch) weight = parseFloat(weightMatch[1]);
                    }
                    if(name.length > 2 && metaFound) {
                        const exObj = { name: name, sets: [] };
                        for(let i=0; i<sets; i++) exObj.sets.push({ weight: weight, reps: reps, rpe: 7, notes: i === 0 ? line : "" });
                        currentExercises.push(exObj); masterExerciseList.add(name);
                    } else sessionNotes += line + "\n";
                } else sessionNotes += line + "\n";
            }
            closeSession(); return sessions;
        }

        window.downloadCSV = async function() {
            if(!dbClient || !currentUserId) return;
            const { data: workouts } = await dbClient.from('workouts').select('*').eq('user_id', currentUserId).order('date', { ascending: false });
            let csv = "data:text/csv;charset=utf-8,Date,Workout,Gym,Exercise,Set,Weight,Reps,RPE,Notes\n";
            for (const w of workouts) {
                const { data: logs } = await dbClient.from('workout_logs').select('*, exercises(name)').eq('workout_id', w.id).order('exercise_order').order('set_index');
                if(logs) logs.forEach(log => {
                    const notes = (log.notes || '').replace(/,/g, ';').replace(/\n/g, ' ');
                    csv += [w.date.split('T')[0], w.name, w.gym_name || 'Gym', log.exercises?.name || '?', log.set_index, log.weight, log.reps, log.rpe || '', notes].join(",") + "\n";
                });
            }
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", `ram_logs_${currentUser}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.switchView = function(viewName) {
            document.getElementById('view-tracker').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if(viewName === 'history') { document.getElementById('actionFooter').classList.add('hidden'); loadHistory(); }
            else if (document.getElementById('exercisesContainer').children.length > 0) { document.getElementById('actionFooter').classList.remove('hidden'); }
        }

        function setDateTime() {
            const now = new Date();
            document.getElementById('workoutDate').value = now.toISOString().split('T')[0];
            document.getElementById('workoutTime').value = now.toTimeString().substring(0, 5);
        }

        function getWorkoutDataFromDOM() {
             return {
                name: document.getElementById('workoutName').value, date: document.getElementById('workoutDate').value,
                time: document.getElementById('workoutTime').value, gym: document.getElementById('gymName').value,
                notes: document.getElementById('generalNotes').value,
                exercises: Array.from(document.querySelectorAll('.exercise-card')).map(card => ({
                    name: card.querySelector('.exercise-name').value,
                    sets: Array.from(card.querySelectorAll('.set-row')).map(row => ({
                        weight: row.querySelector('.set-weight').value, reps: row.querySelector('.set-reps').value,
                        rpe: row.querySelector('.set-rpe').value, notes: row.querySelector('.set-notes').value
                    }))
                }))
            };
        }

        function saveToLocalStorage() { if(currentUser) localStorage.setItem(`ram_draft_${currentUser}`, JSON.stringify(getWorkoutDataFromDOM())); }
        function loadFromLocalStorage() {}
        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), w); }; }
    </script>
</body>
</html>
